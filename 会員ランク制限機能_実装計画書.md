# 会員ランク制限機能 実装計画書

## 📋 概要
会員ランクに応じて刊行物やセミナーへのアクセスを制限し、非ログイン時には高ランクコンテンツをぼかし表示する機能を実装します。
**重要方針**: 既存のページデザインは一切変更せず、現在のUIコンポーネント内でインライン制限表示を実装します。

## 🎯 目標
1. **会員ランクによるアクセス制御**
   - ログイン状態と会員ランクに応じたコンテンツ表示
   - 権限のないコンテンツはぼかし表示（既存デザイン内で実装）

2. **ユーザー体験の向上**
   - 非会員にもコンテンツの存在を示してモチベーション向上
   - 既存UIを活かした自然な制限表示

## 👥 会員ランク構造

### 会員タイプ（3段階）
```php
membership_type: {
  'free'     : '無料会員',      // 基本コンテンツのみ
  'standard' : 'スタンダード会員', // 中級コンテンツまで
  'premium'  : 'プレミアム会員'   // 全てのコンテンツ
}
```

### アクセス権限マトリックス
| コンテンツ | 非ログイン | Free | Standard | Premium |
|----------|----------|------|----------|---------|
| 無料刊行物 | ⭕ | ⭕ | ⭕ | ⭕ |
| スタンダード刊行物 | 🔍ぼかし | ❌ | ⭕ | ⭕ |
| プレミアム刊行物 | 🔍ぼかし | ❌ | ❌ | ⭕ |
| 一般セミナー | ⭕ | ⭕ | ⭕ | ⭕ |
| スタンダードセミナー | 🔍ぼかし | ❌ | ⭕ | ⭕ |
| プレミアムセミナー | 🔍ぼかし | ❌ | ❌ | ⭕ |

## 🏗️ 実装アーキテクチャ

### 1. 認証・会員情報管理
```javascript
// stores/auth.js (Vuex Store)
{
  state: {
    isLoggedIn: false,
    member: {
      id: null,
      name: '',
      email: '',
      membershipType: null, // 'free', 'basic', 'standard', 'premium'
      expiryDate: null
    },
    token: null
  },
  getters: {
    canAccess: (state) => (requiredLevel) => {
      // アクセス権限チェックロジック
    }
  }
}
```

### 2. コンテンツ制限ディレクティブ

#### v-restricted ディレクティブ（既存要素に適用）
```javascript
// directives/restricted.js
export default {
  bind(el, binding) {
    const { membershipLevel, currentLevel } = binding.value
    if (!hasAccess(currentLevel, membershipLevel)) {
      // 既存要素にぼかし効果を追加
      el.style.filter = 'blur(4px)'
      el.style.position = 'relative'
      
      // オーバーレイを追加（デザインを変えない）
      const overlay = document.createElement('div')
      overlay.className = 'restriction-overlay-inline'
      overlay.innerHTML = `
        <span class="lock-icon">🔒</span>
        <span class="restriction-text">${getMembershipText(membershipLevel)}会員限定</span>
      `
      el.appendChild(overlay)
    }
  }
}
```

### 3. 実装が必要なページ・コンポーネント

#### 🔄 修正が必要なコンポーネント

1. **PublicationsMemberPage.vue**
   - 刊行物一覧での制限表示
   - ダウンロードボタンの制御
   - アップグレード誘導

2. **CurrentSeminarsPage.vue**
   - セミナー一覧での制限表示
   - 予約ボタンの制御
   - 会員限定バッジ表示

3. **PublicationDetailPage.vue**
   - 詳細ページでのアクセス制御
   - PDFダウンロード制限

4. **SeminarDetailPage.vue**
   - セミナー詳細のアクセス制御
   - 申込みフォームの制限

#### ✨ 新規作成要素（既存デザイン内に組み込み）

1. **v-restricted ディレクティブ**
   - 既存要素に制限効果を適用

2. **MembershipBadge.vue**
   - 既存のバッジスタイルを活用した会員ランク表示

3. **制限表示CSS**
   - 既存デザインに影響しないインライン制限スタイル

## 📊 データ構造の拡張

### 刊行物（Publications）
```javascript
{
  id: 1,
  title: '経済レポート2025',
  membershipLevel: 'premium', // 追加: 必要な会員レベル
  isRestricted: true,         // 追加: 制限フラグ
  // 既存フィールド...
}
```

### セミナー（Seminars）
```javascript
{
  id: 1,
  title: 'DXセミナー',
  membershipRequirement: 'basic', // 追加: 必要な会員レベル
  isPublic: false,                // 追加: 公開/限定フラグ
  // 既存フィールド...
}
```

## 🎨 UI/UXデザイン仕様（既存デザイン維持）

### ぼかし表示のスタイル（インライン適用）
```css
/* 既存要素に適用する制限スタイル */
.restricted-inline {
  position: relative;
  filter: blur(4px);
  user-select: none;
}

/* 軽量なオーバーレイ（デザインを崩さない） */
.restriction-overlay-inline {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 4px;
  font-size: 14px;
  pointer-events: none;
}

.lock-icon {
  font-size: 16px;
}
```

### 会員ランクバッジ
```css
.membership-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.badge-free { background: #e8f5e9; color: #2e7d32; }
.badge-standard { background: #f3e5f5; color: #7b1fa2; }
.badge-premium { background: #fff3e0; color: #f57c00; }
```

## 🔄 実装フロー

### Phase 1: 基盤構築（2日）
1. ✅ Vuexストアの実装
   - 認証状態管理
   - 会員情報管理
   - アクセス権限チェック

2. ✅ 認証APIの整備
   - ログイン/ログアウト
   - 会員情報取得
   - トークン管理

### Phase 2: 制限表示機能（2日）
1. ✅ v-restricted ディレクティブ作成
2. ✅ MembershipBadge.vue作成（既存スタイル活用）
3. ✅ 制限表示CSS実装（既存デザイン内）

### Phase 3: 刊行物ページ実装（2日）
1. ✅ PublicationsMemberPage.vueへのディレクティブ適用
2. ✅ 既存カード内での制限表示
3. ✅ ダウンロードボタンの条件付き表示

### Phase 4: セミナーページ実装（2日）
1. ✅ CurrentSeminarsPage.vueへのディレクティブ適用
2. ✅ 既存カード内での制限表示
3. ✅ 申込みボタンの条件付き表示

### Phase 5: テスト・調整（2日）
1. ✅ 各会員ランクでの動作確認
2. ✅ 非ログイン状態での表示確認
3. ✅ アップグレードフローの確認

## 🧪 テストシナリオ

### 1. 非ログインユーザー
- [ ] 無料コンテンツは閲覧可能
- [ ] 有料コンテンツはぼかし表示
- [ ] ログイン誘導が表示される

### 2. 無料会員
- [ ] 無料コンテンツのみアクセス可能
- [ ] 有料コンテンツはアップグレード誘導

### 3. スタンダード会員
- [ ] スタンダードレベルまでアクセス可能
- [ ] プレミアムコンテンツは制限表示

### 4. プレミアム会員
- [ ] 全てのコンテンツにアクセス可能
- [ ] 制限表示なし

## 🗄️ Railway PostgreSQLデータベース構造

### 現在のテーブル構造（確認済み）

#### 1. **二重ユーザーシステム**
- **usersテーブル**: 基本認証用
  - membership_type: `['free', 'standard', 'premium']`
  - membership_expires_at: 有効期限
  - membership_features: JSON（カスタム機能アクセス）

- **membersテーブル**: 本格的な会員管理用
  - membership_type: `['basic', 'standard', 'premium']`
  - status: `['pending', 'active', 'suspended', 'cancelled']`
  - company_name, representative_name等のビジネス情報

#### 2. **コンテンツテーブル（アクセス制御フィールド実装済み）**
- **publications**: membership_level フィールド
- **seminars**: membership_requirement フィールド  
- **news**: membership_requirement フィールド

### ✅ データ整合性の確認
**現状**: 会員レベルの統一が必要
- users: `['free', 'standard', 'premium']` ✅ そのまま使用
- members: `['basic', 'standard', 'premium']` → 'basic'を'free'に変更
- publications: 複数のレベル → `['free', 'standard', 'premium']`に統一
- seminars: 複数のレベル → `['free', 'standard', 'premium']`に統一

**統一方針**: 全テーブルで `['free', 'standard', 'premium']` の3段階

### 📊 必要な追加テーブル

#### 1. **member_activity_logs（活動ログ）**
```sql
CREATE TABLE member_activity_logs (
    id BIGSERIAL PRIMARY KEY,
    member_id BIGINT NOT NULL,
    action_type VARCHAR(50) NOT NULL, -- 'login', 'download', 'view_restricted'
    target_type VARCHAR(50),
    target_id BIGINT,
    ip_address VARCHAR(45),
    user_agent TEXT,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (member_id) REFERENCES members(id) ON DELETE CASCADE
);
```

#### 2. **content_access_logs（コンテンツアクセスログ）**
```sql
CREATE TABLE content_access_logs (
    id BIGSERIAL PRIMARY KEY,
    member_id BIGINT,
    content_type VARCHAR(50) NOT NULL,
    content_id BIGINT NOT NULL,
    access_type VARCHAR(20) NOT NULL, -- 'view', 'download', 'denied'
    required_level VARCHAR(20),
    user_level VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (member_id) REFERENCES members(id) ON DELETE SET NULL
);
```

#### 3. **membership_upgrades（アップグレード履歴）**
```sql
CREATE TABLE membership_upgrades (
    id BIGSERIAL PRIMARY KEY,
    member_id BIGINT NOT NULL,
    from_type VARCHAR(20),
    to_type VARCHAR(20) NOT NULL,
    reason TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (member_id) REFERENCES members(id) ON DELETE CASCADE
);
```

## 📝 APIエンドポイント

### 既存API（Laravel側で実装済み）
```php
// 認証関連（実装済み）
POST   /api/auth/login          // ログイン
POST   /api/auth/logout         // ログアウト
GET    /api/user                // ユーザー情報取得

// 管理者認証（実装済み）
POST   /api/admin/login         // 管理者ログイン
GET    /api/admin/me            // 管理者情報取得

// コンテンツAPI（アクセス制御実装済み）
GET    /api/publications        // 刊行物一覧（membership_levelで制御）
GET    /api/seminars           // セミナー一覧（membership_requirementで制御）
```

### 追加が必要なAPI
```php
// アクセス権限確認
GET    /api/member/can-access/{type}/{id}  // アクセス可否確認
POST   /api/member/log-access              // アクセスログ記録
```

## 🔄 必要なマイグレーション

### 1. **会員レベル統一化マイグレーション（3段階）**
```php
// 2025_09_01_000001_standardize_membership_levels.php

// membersテーブル: 'basic'を'free'に変換
Schema::table('members', function (Blueprint $table) {
    DB::statement("UPDATE members SET membership_type = 'free' 
                   WHERE membership_type = 'basic'");
    DB::statement("ALTER TABLE members MODIFY COLUMN membership_type 
                   ENUM('free', 'standard', 'premium') DEFAULT 'free'");
});

// publicationsテーブル: 'basic'を'free'に、その他も統一
Schema::table('publications', function (Blueprint $table) {
    DB::statement("UPDATE publications SET membership_level = 'free' 
                   WHERE membership_level IN ('basic', 'none')");
    DB::statement("ALTER TABLE publications MODIFY COLUMN membership_level 
                   ENUM('free', 'standard', 'premium') DEFAULT 'free'");
});

// seminarsテーブル: 'none'と'basic'を'free'に変換
Schema::table('seminars', function (Blueprint $table) {
    DB::statement("UPDATE seminars SET membership_requirement = 'free' 
                   WHERE membership_requirement IN ('none', 'basic')");
    DB::statement("ALTER TABLE seminars MODIFY COLUMN membership_requirement 
                   ENUM('free', 'standard', 'premium') DEFAULT 'free'");
});
```

### 2. **ログテーブル作成マイグレーション**
```php
// 2025_09_01_000002_create_activity_log_tables.php
Schema::create('member_activity_logs', function (Blueprint $table) {
    $table->id();
    $table->foreignId('member_id')->constrained('members')->onDelete('cascade');
    $table->string('action_type', 50);
    $table->string('target_type', 50)->nullable();
    $table->bigInteger('target_id')->nullable();
    $table->string('ip_address', 45)->nullable();
    $table->text('user_agent')->nullable();
    $table->json('metadata')->nullable();
    $table->timestamps();
    $table->index(['member_id', 'action_type']);
    $table->index('created_at');
});
```

## 🚀 デプロイチェックリスト

### Railway PostgreSQL関連
- [ ] Railway環境変数の確認（DATABASE_URL）
- [ ] PostgreSQL接続テスト
- [ ] マイグレーション実行順序の確認
- [ ] 会員レベル統一化マイグレーションの実行
- [ ] ログテーブルの作成

### アプリケーション設定
- [ ] Laravel Sanctum認証の設定確認
- [ ] CORS設定でVercelドメインを許可
- [ ] APIエンドポイントの疎通確認
- [ ] 会員データの整合性チェック

### フロントエンド実装
- [ ] v-restrictedディレクティブの実装
- [ ] 既存UIでのぼかし表示確認
- [ ] 会員ランクバッジの表示確認
- [ ] アクセス制限時の動作確認

## 📊 成功指標

1. **技術的指標**
   - ページロード時間: 3秒以内
   - エラー率: 1%以下
   - API応答時間: 500ms以内

2. **ビジネス指標**
   - 会員登録率の向上: +20%
   - アップグレード率: +15%
   - コンテンツエンゲージメント: +30%

## ⚠️ 注意事項

1. **セキュリティ**
   - フロントエンドでの制限は見せかけのみ
   - 実際の制限はバックエンド（Laravel）で実装
   - トークンの安全な管理

2. **パフォーマンス**
   - 大量のコンテンツでもスムーズな表示
   - 遅延ローディングの活用
   - キャッシュの適切な利用

3. **ユーザビリティ**
   - 制限理由の明確な表示
   - 既存UIの一貫性維持
   - デザイン変更によるユーザー混乱の回避

## 🔧 技術スタック

- **フロントエンド**: Vue.js 2.x, Vuex, Vue Router
- **バックエンド**: Laravel 8.x
- **認証**: Laravel Sanctum
- **スタイリング**: CSS3, Flexbox, Grid
- **アニメーション**: CSS Transitions, Vue Transitions

## 📅 スケジュール

| フェーズ | 期間 | 状態 |
|---------|-----|------|
| Phase 1: 基盤構築 | 2日 | ✅ 完了 |
| Phase 2: 共通コンポーネント | 2日 | ✅ 完了 |
| Phase 3: 刊行物ページ | 2日 | ✅ 完了 |
| Phase 4: セミナーページ | 2日 | ✅ 完了 |
| Phase 5: テスト・調整 | 2日 | 🔄 実施中 |
| **合計** | **10日** | 90% |

---

作成日: 2025年8月31日
更新日: 2025年9月1日
バージョン: 1.1.0

## 実装済み項目（2025年9月1日）

### ✅ Phase 1-2: 基盤構築と共通コンポーネント
- Vuex認証ストア（auth.js）実装済み
- v-restrictedディレクティブ作成済み
- MembershipBadge.vueコンポーネント作成済み
- 制限表示用CSS実装済み

### ✅ Phase 3: 刊行物ページ実装
- PublicationsMemberPage.vueに制限機能実装
- ダウンロードボタンの条件付き表示
- 会員レベルバッジ表示
- ぼかし効果とオーバーレイ表示

### ✅ Phase 4: セミナーページ実装  
- CurrentSeminarsPage.vueに制限機能実装
- 予約ボタンの条件付き表示
- 会員レベルごとのアクセス制御

### ✅ Laravel側実装
- 会員レベル統一化マイグレーション作成
- 活動ログテーブルマイグレーション作成
- MemberAccessController作成
- APIエンドポイント追加（/api/member/can-access等）

### 🔄 残タスク
- マイグレーションの実行
- 本番環境でのテスト
- エンドツーエンドテスト